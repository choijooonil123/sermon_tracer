<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>설교문 구조 분석 및 음성 하이라이트</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    textarea { width: 100%; height: 200px; }
    .highlight { background-color: yellow; font-weight: bold; }
    .block { margin-left: 0; }
    .indent1 { margin-left: 20px; }
    .indent2 { margin-left: 40px; }
    .context { margin-top: 1em; padding: 1em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>설교문 분석 및 음성 하이라이트</h1>
  <textarea id="sermonInput" placeholder="설교문을 여기에 붙여넣으세요."></textarea><br><br>
  <button onclick="analyzeSermon()">설교문 구조 분석</button>
  <button onclick="startRecognition()">🎤 4초간 음성 인식 시작</button>

  <div id="sermonDisplay"></div>
  <div id="context" class="context"></div>

  <script>
    let sermonLines = [];
    let sermonSpeakables = [];

    function analyzeSermon() {
      const input = document.getElementById("sermonInput").value;
      const lines = input.split(/\n/).filter(l => l.trim() !== "");

      sermonLines = lines.map((line, idx) => {
        let indent = "block";
        if (/^\d+\.\s/.test(line)) indent = "block";
        else if (/^\d+\)\s/.test(line)) indent = "indent1";
        else if (/^\(\d+\)\s/.test(line)) indent = "indent2";
        return { idx, text: line.trim(), indent };
      });

      sermonSpeakables = sermonLines.filter(l => l.text.startsWith("[")).map(l => l.text.replace(/^\[|\]$/g, ''));

      renderSermon();
    }

    function renderSermon(highlightIdx = -1) {
      const container = document.getElementById("sermonDisplay");
      container.innerHTML = "";
      sermonLines.forEach((line, idx) => {
        const div = document.createElement("div");
        div.className = line.indent + (idx === highlightIdx ? " highlight" : "");
        div.textContent = line.text;
        container.appendChild(div);
      });

      if (highlightIdx >= 0) {
        const context = document.getElementById("context");
        const before = sermonLines.slice(Math.max(0, highlightIdx - 3), highlightIdx).map(l => l.text).join("\n");
        const current = sermonLines[highlightIdx].text;
        const after = sermonLines.slice(highlightIdx + 1, highlightIdx + 4).map(l => l.text).join("\n");
        context.innerHTML = `<strong>현재 설교 문맥</strong><br><pre>${before}\n<span class="highlight">${current}</span>\n${after}</pre>`;
      }
    }

    function startRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("이 브라우저는 음성 인식을 지원하지 않습니다.");
        return;
      }

      const recognition = new webkitSpeechRecognition();
      recognition.lang = "ko-KR";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const speechText = event.results[0][0].transcript.trim();
        matchSpeechToSermon(speechText);
      };

      recognition.start();

      setTimeout(() => recognition.stop(), 4000);
    }

    function matchSpeechToSermon(speech) {
      let bestMatchIdx = -1;
      let maxScore = 0;

      sermonLines.forEach((line, idx) => {
        const clean = line.text.replace(/[\[\]]/g, '');
        const score = similarity(speech, clean);
        if (score > maxScore) {
          maxScore = score;
          bestMatchIdx = idx;
        }
      });

      if (maxScore > 0.4) {
        renderSermon(bestMatchIdx);
      } else {
        alert("일치하는 문장을 찾을 수 없습니다.\n음성 내용: " + speech);
      }
    }

    function similarity(a, b) {
      a = a.toLowerCase();
      b = b.toLowerCase();
      const aWords = a.split(/\s+/);
      const bWords = b.split(/\s+/);
      const matchCount = aWords.filter(w => bWords.includes(w)).length;
      return matchCount / Math.max(aWords.length, bWords.length);
    }
  </script>
</body>
</html>
