<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>설교추적시스템 001</title>
  <style>
    body {
      font-family: Arial;
      padding: 30px;
      background: #f9f9f9;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-size: 1em;
      padding: 10px;
      white-space: pre-wrap;
    }
    #previewBox {
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      margin-top: 20px;
      line-height: 1.8;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .unitBox {
      padding: 10px;
      margin: 5px 0;
      border-left: 6px solid transparent;
    }
    .level1 {
      border-color: #007acc;
      background: #e6f2ff;
    }
    .level2 {
      border-color: #33aa33;
      background: #e8ffe8;
      margin-left: 20px;
    }
    .level3 {
      border-color: #e69500;
      background: #fff3e6;
      margin-left: 40px;
    }
    .selected {
      background: #fff7b2 !important;
      font-weight: bold;
      font-size: 1.2em;
    }
    #liveTranscript {
      margin-top: 10px;
      padding: 10px;
      background: #eef;
      font-style: italic;
      border: 1px dashed #88a;
    }
  </style>
</head>
<body>

<h2>📖 설교추적시스템</h2>

<p>설교 입력란:</p>
<textarea id="sermonInput" placeholder="예: 1. 서론\n1) 믿음이란\n(1) 바라는 것들의 실상..."></textarea>

<button onclick="startRecognition()">🎙️ 음성 인식 시작</button>
<div id="liveTranscript">🗣️ 인식된 텍스트: <span id="speechText">(없음)</span></div>

<div id="previewBox"></div>

<script>
let selectedIndex = 0;
let currentUnits = [];

function parseSermonByPattern(text) {
  const lines = text.split(/\n+/);
  const units = [];
  lines.forEach(line => {
    line = line.trim();
    if (/^\d+\.\s+/.test(line)) {
      units.push({ level: 1, content: line });
    } else if (/^\d+\)\s+/.test(line)) {
      units.push({ level: 2, content: line });
    } else if (/^\(\d+\)\s+/.test(line)) {
      units.push({ level: 3, content: line });
    } else if (line.length > 0) {
      units.push({ level: 3, content: line });
    }
  });
  return units;
}

function renderPreview(units) {
  const preview = document.getElementById("previewBox");
  preview.innerHTML = units.map((u, i) => {
    const isSelected = i === selectedIndex;
    const classes = `unitBox level${u.level}` + (isSelected ? ' selected' : '');
    return `<div class="${classes}" id="unit-${i}">${u.content}</div>`;
  }).join("");

  const current = document.getElementById(`unit-${selectedIndex}`);
  if (current) {
    current.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

document.getElementById("sermonInput").addEventListener("input", () => {
  const text = document.getElementById("sermonInput").value;
  currentUnits = parseSermonByPattern(text);
  selectedIndex = 0;
  renderPreview(currentUnits);
});

document.addEventListener("keydown", e => {
  if (["ArrowLeft", "ArrowUp", "PageUp"].includes(e.key)) {
    selectedIndex = Math.max(0, selectedIndex - 1);
  } else if (["ArrowRight", "ArrowDown", "PageDown"].includes(e.key)) {
    selectedIndex = Math.min(currentUnits.length - 1, selectedIndex + 1);
  } else {
    return;
  }
  renderPreview(currentUnits);
});

function startRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    alert('Web Speech API를 지원하지 않는 브라우저입니다.');
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'ko-KR';
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = event => {
    const transcript = Array.from(event.results)
      .map(result => result[0].transcript)
      .join('');
    document.getElementById("speechText").innerText = transcript;
  };

  recognition.start();
}
</script>

</body>
</html>
